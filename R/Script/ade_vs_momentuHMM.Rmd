---
title: "CRW vs. HMM for spatial interpolation"
author: "Benjamin Dupuis"
date: "06/10/2021"
output:
  html_document:
    df_print: kable
    highlight: espresso
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 300)
```

# Prepare the data
```{r prelude, message=FALSE}
rm(list = ls())
set.seed(2498)

library(tidyverse);library(lubridate);library(sp);library(sf)
library(adehabitatLT);library(momentuHMM); library(ggspatial)
```

First we load the cleaned GPS samples.
```{r load}
mysample <- list.files("Data/Samples/Cleaned", full.names = TRUE)
list_gps <- lapply(mysample, readRDS)
track_names <- tools::file_path_sans_ext(list.files("Data/Samples/Cleaned"))
names(list_gps) <- track_names
```

Then we project the data, using ESPG GDA94/ Australian ALbers
```{r projection, message=F, warning=F}
lpproj <- list_gps[[1]]

world <- rnaturalearth::ne_countries(scale = 10, returnclass = "sf")

# Prepare CRS Strings
# CRS for WGS84
proj.latlon <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#CRS string for australia
ESPG <- x<-rgdal::make_EPSG()
myESPG <- ESPG[grep("GDA94 / Australian Albers", ESPG$note),]
proj.aeqd <- myESPG$prj4

#Transform to spatial object 
coordinates(lpproj) <- ~ Longitude + Latitude

# Define CRS
proj4string(lpproj) <- CRS(proj.latlon)

# Project the data
lpproj <- spTransform(lpproj, CRS(proj.aeqd))

#Prepare for momentuHMM
obstimes <- as.numeric(lpproj$Dt) / 3600 # convert time to numeric hours
lnError <- crawl::argosDiag2Cov(50,50,0) # assume 50m isotropic error ellipse
lpdata <- data.frame(ID=1,
                     time=obstimes,
                     x=lpproj@coords[, 1],
                     y=lpproj@coords[, 2],
                     ln.sd.x=lnError$ln.sd.x, 
                     ln.sd.y = lnError$ln.sd.y, 
                     error.corr= lnError$error.corr)

#Check the track
ori_plot <- ggplot(data = world) + 
  geom_sf() +
  geom_path(data = lpdata, aes(x, y), color = "#440154FF") +
  geom_point(data = lpdata, aes(x, y), color = "#440154FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(min(lpdata$x), max(lpdata$x)), ylim = c(min(lpdata$y), max(lpdata$y))) +
  labs(title = "original track") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))
```

# Using adehabitatLT::redisltraj
The first method uses the package adehabitatLT. First we need to transform our dataframe into a ltraj object, then we interpolate the data to have a position every 15 minutes.
```{r adehabitat}
mytraj <- as.ltraj(xy = lpproj@coords,
                   date = lpproj$Dt,
                   id = paste0(lpproj$Stage, lpproj$Nest, lpproj$Sex),
                   typeII = TRUE)
ade_traj <- redisltraj(mytraj, 900, type = "time")

correc_ade <- ade_traj[[1]] 

#Check the track
ade_plot <- ggplot(data = world) + 
  geom_sf() +
  geom_path(data = correc_ade, aes(x, y), color = "#21908CFF") +
  geom_point(data = correc_ade, aes(x, y), color = "#21908CFF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(min(lpdata$x), max(lpdata$x)), ylim = c(min(lpdata$y), max(lpdata$y))) +
  labs(title = "ade track") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))
```

# Using momentuHMM
First we project the data, using the ESPG GDA94/Australian Albers
```{r momentuHMM, message=F}
crwOut <- crawlWrap(lpdata,theta=c(6.5,-.1),fixPar=c(1,1,NA,NA),
                    err.model = list(x=~ln.sd.x-1,y=~ln.sd.y-1,rho=~error.corr),
                    timeStep=0.25, # predict at 15 min time steps
                    attempts=10)

correc_mom <- crwOut$crwPredict

mom_plot <- ggplot(data = world) + 
  geom_sf() +
  geom_path(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF") +
  geom_point(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(min(lpdata$x), max(lpdata$x)), ylim = c(min(lpdata$y), max(lpdata$y))) +
  labs(title = "momentuHMM track") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))

ori_plot;ade_plot;mom_plot

over_plot <- ggplot(data = world) +
  geom_sf() +
  geom_path(data = correc_ade, aes(x, y), color = "#21908CFF") +
  geom_point(data = correc_ade, aes(x, y), color = "#21908CFF", alpha = 0.5) +
  geom_path(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF") +
  geom_point(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF", alpha = 0.5) +
  geom_path(data = lpdata, aes(x, y), color = "#440154FF") +
  geom_point(data = lpdata, aes(x, y), color = "#440154FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(min(lpdata$x), max(lpdata$x)), ylim = c(min(lpdata$y), max(lpdata$y))) +
  labs(title = "overlaped track") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))

over_plot

zoom_over_plot <- ggplot(data = world) +
  geom_sf() +
  geom_path(data = correc_ade, aes(x, y), color = "#21908CFF") +
  geom_point(data = correc_ade, aes(x, y), color = "#21908CFF", alpha = 0.5) +
  geom_path(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF") +
  geom_point(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF", alpha = 0.5) +
  geom_path(data = lpdata, aes(x, y), color = "#440154FF") +
  geom_point(data = lpdata, aes(x, y), color = "#440154FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(1160000, 1165000), ylim = c(-4290000, -4285000)) +
  labs(title = "overlaped zoomed track") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))

zoom_over_plot
```

# With 5km error (50 m previously)

```{r 5km, echo=FALSE, message=F, warning=F}
lpproj <- list_gps[[1]]

world <- rnaturalearth::ne_countries(scale = 10, returnclass = "sf")

# Prepare CRS Strings
# CRS for WGS84
proj.latlon <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"

#CRS string for australia
ESPG <- x<-rgdal::make_EPSG()
myESPG <- ESPG[grep("GDA94 / Australian Albers", ESPG$note),]
proj.aeqd <- myESPG$prj4

#Transform to spatial object 
coordinates(lpproj) <- ~ Longitude + Latitude

# Define CRS
proj4string(lpproj) <- CRS(proj.latlon)

# Project the data
lpproj <- spTransform(lpproj, CRS(proj.aeqd))

#Prepare for momentuHMM
obstimes <- as.numeric(lpproj$Dt) / 3600 # convert time to numeric hours
lnError <- crawl::argosDiag2Cov(5000,5000,0) # assume 50m isotropic error ellipse
lpdata <- data.frame(ID=1,
                     time=obstimes,
                     x=lpproj@coords[, 1],
                     y=lpproj@coords[, 2],
                     ln.sd.x=lnError$ln.sd.x, 
                     ln.sd.y = lnError$ln.sd.y, 
                     error.corr= lnError$error.corr)

mytraj <- as.ltraj(xy = lpproj@coords,
                   date = lpproj$Dt,
                   id = paste0(lpproj$Stage, lpproj$Nest, lpproj$Sex),
                   typeII = TRUE)
ade_traj <- redisltraj(mytraj, 900, type = "time")

correc_ade <- ade_traj[[1]] 

crwOut <- crawlWrap(lpdata,theta=c(6.5,-.1),fixPar=c(1,1,NA,NA),
                    err.model = list(x=~ln.sd.x-1,y=~ln.sd.y-1,rho=~error.corr),
                    timeStep=0.25, # predict at 15 min time steps
                    attempts=10)

correc_mom <- crwOut$crwPredict

over_plot <- ggplot(data = world) +
  geom_sf() +
  geom_path(data = correc_ade, aes(x, y), color = "#21908CFF") +
  geom_point(data = correc_ade, aes(x, y), color = "#21908CFF", alpha = 0.5) +
  geom_path(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF") +
  geom_point(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF", alpha = 0.5) +
  geom_path(data = lpdata, aes(x, y), color = "#440154FF") +
  geom_point(data = lpdata, aes(x, y), color = "#440154FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(min(lpdata$x), max(lpdata$x)), ylim = c(min(lpdata$y), max(lpdata$y))) +
  labs(title = "overlaped track (5km error") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))

over_plot

zoom_over_plot <- ggplot(data = world) +
  geom_sf() +
  geom_path(data = correc_ade, aes(x, y), color = "#21908CFF") +
  geom_point(data = correc_ade, aes(x, y), color = "#21908CFF", alpha = 0.5) +
  geom_path(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF") +
  geom_point(data = correc_mom, aes(mu.x, mu.y), color = "#FDE725FF", alpha = 0.5) +
  geom_path(data = lpdata, aes(x, y), color = "#440154FF") +
  geom_point(data = lpdata, aes(x, y), color = "#440154FF", alpha = 0.5) +
  annotation_scale(location = "bl", width_hint = 0.25, text_cex = 1.3) +
  coord_sf(crs = proj.aeqd, expand = T, xlim = c(1160000, 1165000), ylim = c(-4290000, -4285000)) +
  labs(title = "overlaped zoomed track (5km error)") +
  theme_bw() +
  theme(panel.grid = element_line(color = "#C4C4C4"))

zoom_over_plot
```
