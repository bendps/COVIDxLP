---
title: "HMM - Behavioural classification"
author: "Benjamin Dupuis"
date: "20/10/2021"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: yeti
    highlight: kate
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r preambule, message = FALSE}
rm(list = ls())
set.seed(2498)
library(tidyverse);library(momentuHMM)
```

# Data Exploration
First we just load the output data frow the `crawlWrap` function. We can reshape it using `prepdata` to have something readable for the HMM.
```{r load}
crwOut <- readRDS("Data/LPPI2019/Interpolated_GPS_Depth_2019.rds")
lpdata <- prepData(crwOut)

head(lpdata)
```

Then we check the distribution of our variable to estimate the starting parameters of the HMM
```{r explore}
hist(lpdata$step, breaks = 20)
hist(lpdata$angle)
hist(lpdata$prop_dive)
```

# Model with 2 States
First we try to fit a 2 states HMM to our data. The first state correspond to a foraging behaviour, with small speed and high proportion of dives. The second one correspond to the transiting behaviour, with high speed and small proportion of dives. Warning messages are OK here, only du to NAs.
```{r 2 states HMM}
#Label states
stateNames <- c("Foraging","Transit")

#Distributions for observation processes
dist <- list(step = "gamma", angle = "vm", prop_dive = "gamma")

#Initial parameters for gamma and von Mises distributions
mu0 <- c(200,1000) #Step mean 
sigma0 <- c(100,400) #Step SD
#zeromass0 <- c(0.5,1) #Step zero-mass
stepPar0 <- c(mu0,sigma0)

angleMean0 <- c(0.1,0.1) # angle mean
#kappa0 <- c(1,1,1) # angle concentration
anglePar0 <- c(angleMean0)

mu0 <- c(0.6,0.1) #Dive mean 
sigma0 <- c(0.2,0.05) #Dive SD
zeromass0 <- c(0.01,0.1) #Dive zero-mass
divePar0 <- c(mu0,sigma0,zeromass0)

Par0_m1 <- list(step = stepPar0, angle = anglePar0, prop_dive = divePar0)

#Call to fitting function
m1 <- fitHMM(data = lpdata, nbStates = 2, dist = dist, Par0 = Par0_m1, stateNames = stateNames)

m1
```

# Model with 3 States
Another possibility is to fit 3 states to our data with the HMM. The third state would be a mixture of foraging and transiting, with high speed and high proportion of dives. The idea is that this state is generated during the interpolation of long straight lines. Starting parameters are not yet ideal.
```{r 3 states HMM}
#Label states
stateNames <- c("Foraging","Transit", "Mixture")

#Distributions for observation processes
dist <- list(step = "gamma", angle = "vm", prop_dive = "gamma")

#Initial parameters for gamma and von Mises distributions
mu0 <- c(200,1000,800) #Step mean 
sigma0 <- c(100,400,200) #Step SD
#zeromass0 <- c(0.5,1) #Step zero-mass
stepPar0 <- c(mu0,sigma0)

angleMean0 <- c(0.1,0.1,0.1) # angle mean
#kappa0 <- c(1,1,1) # angle concentration
anglePar0 <- c(angleMean0)

mu0 <- c(0.6,0.1,0.4) #Dive mean 
sigma0 <- c(0.2,0.05,0.1) #Dive SD
zeromass0 <- c(0.01,0.1,0.05) #Dive zero-mass
divePar0 <- c(mu0,sigma0,zeromass0)

Par0_m1 <- list(step = stepPar0, angle = anglePar0, prop_dive = divePar0)

#Call to fitting function
m2 <- fitHMM(data = lpdata, nbStates = 3, dist = dist, Par0 = Par0_m1, stateNames = stateNames)

m2
```

